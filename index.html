<!DOCTYPE html>
<html>

<head>
	<title> MÁY TRỢ THỞ - Trường THCS Tam Dương</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta charset="utf-8">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js" type="text/javascript"></script>
    <script type = "text/javascript" language = "javascript">
	 	var max,at_OK;
	    function makeid() 
	    {
		  var text = "";
		  var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";

		  for (var i = 0; i < 5; i++)
		    text += possible.charAt(Math.floor(Math.random() * possible.length));

		  return text;
		}
	 	// Create a client instance
		var client = new Paho.MQTT.Client("broker.hivemq.com", 8000, makeid());

		// set callback handlers
		client.onConnectionLost = onConnectionLost;
		client.onMessageArrived = onMessageArrived;

		var options = {
		    useSSL: false,
		    userName: "",
		    password: "",
		    onSuccess:onConnect,
		    onFailure:doFail
		 }

        
        console.log("Connect to broker.hivemq.com:8000");
		// connect the client
		client.connect(options);

		 function doFail(e){
		    console.log(e);
		 }

		function onConnect() //sự kiên kết nối thành công
		{
		  console.log("Connect OK");
		  client.subscribe("DTIs_NhipTim"); //đăng kí kênh 
		  client.subscribe("DTIs_SpO2");
		  client.subscribe("DTIs_NhipTho");
		  client.subscribe("DTIs_TheTich");
		}

		// called when the client loses its connection
		function onConnectionLost(responseObject) 
		{
		  if (responseObject.errorCode !== 0) 
		  {
		    console.log(responseObject.errorMessage);
		  }
		}

		// called when a message arrives
		function onMessageArrived(message) 
		{
		  console.log(message.destinationName + ":" +message.payloadString);
		  if(message.destinationName == "DTIs_NhipTim") addValue(message.payloadString);
		  //if(message.destinationName == "DTIs_NhipTho") updateNhipTho(message.payloadString);
		  //if(message.destinationName == "DTIs_TheTich") updateTheTich(message.payloadString);
		  document.getElementById(message.destinationName).innerHTML = message.payloadString;
		}
		function public (topic,data)
	      {
	        message = new Paho.MQTT.Message(data);
	        message.destinationName = topic;
	        client.send(message);
	      }
    </script>
	<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
	<style>
	.slidecontainer {
	  width: 100%;
	}

	.slider {
	  -webkit-appearance: none;
	  width: 200px;
	  height: 15px;
	  border-radius: 5px;
	  background: #d3d3d3;
	  outline: none;
	  opacity: 0.7;
	  -webkit-transition: .2s;
	  transition: opacity .2s;
	}

	.slider:hover {
	  opacity: 1;
	}

	.slider::-webkit-slider-thumb {
	  -webkit-appearance: none;
	  appearance: none;
	  width: 25px;
	  height: 25px;
	  border-radius: 50%;
	  background: #04AA6D;
	  cursor: pointer;
	}

	.slider::-moz-range-thumb {
	  width: 25px;
	  height: 25px;
	  border-radius: 50%;
	  background: #04AA6D;
	  cursor: pointer;
	}
	</style>
</head>
<body style="background-image: url('hinhnen.jpg');">

<h1 align="center"> Hỗ trợ cấp cứu và Giám sát bệnh nhân từ xa 4.0 </h1>

<table align="center">
	<tr >
		<td rowspan="5"><div id="myPlot" style="width:100%;max-width:700px"></div></td>
	</tr>
	<tr>
		<td><img src="heartbeat.png" style="width:100px;height:100px;"></td>
		<td><h1 align="center" style="color:red" id="DTIs_NhipTim"> 00 </h1></td>
		<td> bpm </td>
	</tr>
	<tr>
		<td><img src="spo2.png" style="width:100px;height:100px;"></td>
		<td><h1 align="center" style="color:blue" id="DTIs_SpO2"> 00 </h1></td>
		<td> % </td>
		<td><h3 align="center"> <button style="color:red; width:100px;" onclick="setmode()"><h3> Cài đặt </h3></button></h3></td>
	</tr>
	<tr>
		<td><h2> Nhịp thở: </h2></td>
		<td><h2 align="center" style="color:green; width:50px;"><span id="DTIs_NhipTho"> 00 </span></h2></td>
		<td> Nhịp/phút </td>
		<td><input type="range" min="1" max="100" value="1" class="slider" id="tocdo"></td>
	</tr>
	<tr>
		<td><h2> Thể tích: </h2></td>
		<td><h2 align="center" style="color:green; width:50px;"><span id="DTIs_TheTich"> 00 </span></h2></td>
		<td> % </td>
		<td><input type="range" min="0" max="100" step="20" value="0" class="slider" id="ptram"></td>
	</tr>
	
	
</table>
<br><br><br><br>
<h2 align="center" style="color:red;"><i> Trường THCS Tam Dương - Huyện Tam Dương </i></h2>

<script>
var xValues = [];
var yValues = [];

var soGT=50;
for(i=0;i<soGT;i++)
{
	xValues.push(i);
	yValues.push(0);
}
var data = [{
  x: xValues,
  y: yValues,
  mode:"lines"
}];
var layout = {
  xaxis: {range: [0, soGT]},
  yaxis: {range: [0, 100], title: "bpm"},  
  title: "Nhịp Tim"
};
Plotly.newPlot("myPlot", data, layout);


function addValue(xnt){
	for(i=0; i<soGT-1; i++) yValues[i] = yValues[i+1];
	yValues[soGT-1] = xnt;
	Plotly.update("myPlot", data, layout);
}
</script>

<script>
var hidden = 1;
var sliderTocDo = document.getElementById("tocdo");
var labelTocDo = document.getElementById("DTIs_NhipTho");
var sliderPTram = document.getElementById("ptram");
var labelPTram = document.getElementById("DTIs_TheTich");
labelTocDo.innerHTML = sliderTocDo.value;
labelPTram.innerHTML = sliderPTram.value;

sliderTocDo.style.visibility = 'hidden';
sliderPTram.style.visibility = 'hidden';

sliderTocDo.onchange = function() {
  labelTocDo.innerHTML = this.value;
  public("DTIs_NhipTho2", this.value);
  console.log("Tdo-------------");
}
sliderPTram.onchange = function() {
  labelPTram.innerHTML = this.value;
  public("DTIs_TheTich2", this.value);
  console.log("PTram-------------");
}
function updateNhipTho(xtd)
{
	sliderTocDo.value = xtd;
}
function updateTheTich(xtt)
{
	sliderPTram.value = xtt;
}
function setmode()
{
	hidden = 1-hidden;
	public("DTIs_Mode", hidden.toString());
	if(hidden) {
		sliderTocDo.style.visibility = 'hidden';
		sliderPTram.style.visibility = 'hidden';
	} else {
		sliderTocDo.style.visibility = 'visible';
		sliderPTram.style.visibility = 'visible';
	}
}
</script>

</body>
</html>